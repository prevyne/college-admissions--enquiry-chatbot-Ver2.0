<!DOCTYPE html>
<html>
<head>
    <title>College Admissions Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex; /* Use flexbox for layout */
            height: 100vh; /* Full viewport height */
            overflow: hidden; /* Prevent body scroll */
        }

        #sidebar {
            width: 250px; /* Fixed width for sidebar */
            background-color: #e9e9e9;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto; /* Scroll sidebar if content overflows */
        }

        #sidebar h2 {
            margin-top: 0;
            text-align: center;
            color: #333;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }

        #new-chat-button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1em;
        }
        #new-chat-button:hover {
            background-color: #4cae4c;
        }

        #chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Allow list to take remaining space */
            overflow-y: auto; /* Scroll list if needed */
        }

        #chat-list li {
            background-color: #fff;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            padding: 8px 10px;
        }
         #chat-list li.active {
             background-color: #dcf8c6; /* Highlight active chat */
             border-left: 5px solid #5cb85c;
         }


        #chat-list a.chat-title-link {
            text-decoration: none;
            color: #333;
            display: block;
            margin-bottom: 5px; /* Space between title and actions */
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis if title is too long */
        }
         #chat-list a.chat-title-link:hover {
             color: #007bff;
         }

        .chat-actions {
            display: flex;
            justify-content: space-between; /* Space out buttons */
            align-items: center;
        }
         .chat-actions form {
             margin: 0; /* Remove default form margin */
             display: inline; /* Keep buttons inline */
         }

        .chat-actions button, .chat-actions a {
            padding: 3px 8px;
            font-size: 0.8em;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
        }
         .chat-actions .delete-button {
             background-color: #f44336;
             color: white;
             border: none;
         }
          .chat-actions .delete-button:hover {
              background-color: #d32f2f;
          }

         .chat-actions .export-button {
             background-color: #007bff;
             color: white;
             border: 1px solid #007bff;
             margin-left: 5px;
             display: inline-block; /* Consistent display */
         }
         .chat-actions .export-button:hover {
             background-color: #0056b3;
         }


        #main-content {
            flex-grow: 1; /* Allow main content to take remaining width */
            display: flex;
            flex-direction: column; /* Stack title, chatbox, input */
            height: 100%;
        }

         #chat-header {
             padding: 15px;
             background-color: #f8f9fa;
             border-bottom: 1px solid #ccc;
             font-size: 1.2em;
             font-weight: bold;
             color: #333;
             text-align: center;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
         }

        #chatbox {
            flex-grow: 1; /* Allow chatbox to fill available vertical space */
            overflow-y: scroll;
            padding: 15px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
        }

        .chat-message {
            padding: 8px 12px;
            margin-bottom: 10px;
            border-radius: 15px;
            max-width: 70%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .user-message {
            background-color: #dcf8c6;
            align-self: flex-end;
            margin-left: auto;
        }
        .bot-message {
            background-color: #eee;
            align-self: flex-start;
            margin-right: auto;
        }

        #userInput {
            display: flex;
            padding: 15px;
            border-top: 1px solid #ccc;
            background-color: #f8f9fa;
        }
        #textInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px 0 0 5px;
            font-size: 1em;
        }
        #sendButton {
            padding: 10px 15px;
            background-color: #5cb85c;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 0 5px 5px 0;
            font-size: 1em;
        }
        #sendButton:hover {
            background-color: #4cae4c;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Chat History</h2>

        <form action="{{ url_for('new_chat') }}" method="post">
            <button id="new-chat-button" type="submit">Start New Chat</button>
        </form>

        <ul id="chat-list">
            {% if chat_list %}
                {% for chat in chat_list %}
                    <li {% if chat.chat_id == current_chat_id %} class="active" {% endif %}>
                        <a href="{{ url_for('load_chat', chat_id=chat.chat_id) }}" class="chat-title-link" title="{{ chat.title }} ({{ chat.created_at }})">
                           {{ chat.title }}
                        </a>
                        <div class="chat-actions">
                             <form action="{{ url_for('delete_chat_route', chat_id=chat.chat_id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this chat?');">
                                 <button type="submit" class="delete-button" title="Delete Chat">Delete</button>
                             </form>
                             <div>
                                 <a href="{{ url_for('export_chat_route', chat_id=chat.chat_id, format='txt') }}" class="export-button" title="Export as TXT">TXT</a>
                                 <a href="{{ url_for('export_chat_route', chat_id=chat.chat_id, format='json') }}" class="export-button" title="Export as JSON">JSON</a>
                             </div>
                        </div>
                    </li>
                {% endfor %}
            {% else %}
                <li>No saved chats found.</li>
            {% endif %}
        </ul>
    </div>

    <div id="main-content">
        <div id="chat-header">
             {{ chat_title | default('College Admissions Assistant', true) }}
        </div>

        <div id="chatbox">
            {% for msg in messages %}
                <div class="chat-message {{ 'user-message' if msg.sender == 'user' else 'bot-message' }}">
                    {{ msg.message }}
                    {# Optional: Display timestamp #}
                    {# <span class="timestamp">{{ msg.timestamp }}</span> #}
                </div>
            {% endfor %}
            </div>

        <div id="userInput">
            <input id="textInput" type="text" name="msg" placeholder="Type your message here..." autocomplete="off"/>
            <button id="sendButton" type="button">Send</button>
        </div>
    </div>

    <script>
        const chatbox = document.getElementById('chatbox');
        const textInput = document.getElementById('textInput');
        const sendButton = document.getElementById('sendButton');

        // Function to append a message to the chatbox div
        function appendMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            // To prevent basic HTML injection, set textContent instead of innerHTML
            messageDiv.textContent = message;
            chatbox.appendChild(messageDiv);
            // Scroll to the bottom
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // Function to handle sending message and receiving response
        function getBotResponse() {
            const userMessage = textInput.value.trim();
            if (userMessage === "") return; // Don't send empty messages

            appendMessage(userMessage, 'user'); // Display user message immediately
            textInput.value = ""; // Clear input field

            // Send message to Flask backend
            // Note: The backend now handles saving via session's current_chat_id
            fetch(`/get?msg=${encodeURIComponent(userMessage)}`)
                .then(response => {
                    if (!response.ok) {
                        // Try to get error message from JSON response if possible
                         return response.json().then(errData => {
                              throw new Error(errData.response || `HTTP error! status: ${response.status}`);
                         }).catch(() => {
                              // Fallback if response is not JSON or doesn't have 'response' field
                              throw new Error(`HTTP error! status: ${response.status}`);
                         });
                    }
                    return response.json();
                 })
                .then(data => {
                    const botMessage = data.response;
                     // If a new chat was created, the page might need a reload
                     // to update the chat list and title, but for simplicity,
                     // we just append the message here. A full reload is handled
                     // by the redirects in load/new/delete routes.
                    appendMessage(botMessage, 'bot');
                })
                .catch(error => {
                    console.error('Error fetching bot response:', error);
                    appendMessage(`Sorry, an error occurred: ${error.message}. Please try again.`, 'bot');
                });
        }

        // Scroll chatbox to bottom on initial load if there are messages
        function scrollToBottom() {
             chatbox.scrollTop = chatbox.scrollHeight;
        }

        // Event listeners
        sendButton.addEventListener('click', getBotResponse);
        textInput.addEventListener('keypress', function(e) {
            // Send message if Enter key is pressed
            if (e.key === 'Enter') {
                getBotResponse();
            }
        });

        // Run scroll to bottom after page loads
        window.addEventListener('load', scrollToBottom);

    </script>

</body>
</html>