<!DOCTYPE html>
<html>
<head>
    <title>College Admissions Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="background"></div>

    <div id="sidebar">
        <h2>Chat History</h2>

        <form action="{{ url_for('new_chat') }}" method="post">
            <button id="new-chat-button" type="submit">Start New Chat</button>
        </form>

        <ul id="chat-list">
            {% if chat_list %}
                {% for chat in chat_list %}
                    <li {% if chat.chat_id == current_chat_id %} class="active" {% endif %}>
                        <a href="{{ url_for('load_chat', chat_id=chat.chat_id) }}" class="chat-title-link" title="{{ chat.title }} ({{ chat.created_at }})">
                           {{ chat.title }}
                        </a>
                        <div class="chat-actions">
                             <form action="{{ url_for('delete_chat_route', chat_id=chat.chat_id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this chat?');">
                                 <button type="submit" class="delete-button" title="Delete Chat">Delete</button>
                             </form>
                             <div>
                                 <a href="{{ url_for('export_chat_route', chat_id=chat.chat_id, format='txt') }}" class="export-button" title="Export as TXT">TXT</a>
                                 <a href="{{ url_for('export_chat_route', chat_id=chat.chat_id, format='json') }}" class="export-button" title="Export as JSON">JSON</a>
                             </div>
                        </div>
                    </li>
                {% endfor %}
            {% else %}
                <li>No saved chats found.</li>
            {% endif %}
        </ul>
    </div>

    <div id="main-content">
        <div id="chat-header">
             {{ chat_title | default('College Admissions Assistant', true) }}
        </div>

        <div id="chatbox">
            {% for msg in messages %}
                <div class="chat-message {{ 'user-message' if msg.sender == 'user' else 'bot-message' }}">
                    {{ msg.message }}
                    {# Optional: Display timestamp #}
                    {# <span class="timestamp">{{ msg.timestamp }}</span> #}
                </div>
            {% endfor %}
            </div>

        <div id="userInput">
            <input id="textInput" type="text" name="msg" placeholder="Type your message here..." autocomplete="off"/>
            <button id="sendButton" type="button">Send</button>
        </div>
    </div>

    <script>
        const chatbox = document.getElementById('chatbox');
        const textInput = document.getElementById('textInput');
        const sendButton = document.getElementById('sendButton');

        // Function to append a message to the chatbox div
        function appendMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            // To prevent basic HTML injection, set textContent instead of innerHTML
            messageDiv.textContent = message;
            chatbox.appendChild(messageDiv);
            // Scroll to the bottom
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // Function to handle sending message and receiving response
        function getBotResponse() {
            const userMessage = textInput.value.trim();
            if (userMessage === "") return; // Don't send empty messages

            appendMessage(userMessage, 'user'); // Display user message immediately
            textInput.value = ""; // Clear input field

            // Send message to Flask backend
            // Note: The backend now handles saving via session's current_chat_id
            fetch(`/get?msg=${encodeURIComponent(userMessage)}`)
                .then(response => {
                    if (!response.ok) {
                        // Try to get error message from JSON response if possible
                         return response.json().then(errData => {
                              throw new Error(errData.response || `HTTP error! status: ${response.status}`);
                         }).catch(() => {
                              // Fallback if response is not JSON or doesn't have 'response' field
                              throw new Error(`HTTP error! status: ${response.status}`);
                         });
                    }
                    return response.json();
                 })
                .then(data => {
                    const botMessage = data.response;
                     // If a new chat was created, the page might need a reload
                     // to update the chat list and title, but for simplicity,
                     // we just append the message here. A full reload is handled
                     // by the redirects in load/new/delete routes.
                    appendMessage(botMessage, 'bot');
                })
                .catch(error => {
                    console.error('Error fetching bot response:', error);
                    appendMessage(`Sorry, an error occurred: ${error.message}. Please try again.`, 'bot');
                });
        }

        // Scroll chatbox to bottom on initial load if there are messages
        function scrollToBottom() {
             chatbox.scrollTop = chatbox.scrollHeight;
        }

        // Event listeners
        sendButton.addEventListener('click', getBotResponse);
        textInput.addEventListener('keypress', function(e) {
            // Send message if Enter key is pressed
            if (e.key === 'Enter') {
                getBotResponse();
            }
        });

        // Run scroll to bottom after page loads
        window.addEventListener('load', scrollToBottom);

    </script>

</body>
</html>